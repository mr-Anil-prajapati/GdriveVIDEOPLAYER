<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Switchable VR/Normal Player with Previews</title>

<link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
<link href="https://unpkg.com/videojs-vr/dist/videojs-vr.css" rel="stylesheet">

<style>
  body { font-family: Arial; margin: 0; background: #111; color: #fff; height: 100vh; overflow: hidden; }
  
  .container { display: flex; height: 100%; width: 100%; }
  
  /* Main Player Area */
  .player-section { 
    flex: 3; 
    padding: 20px; 
    display: flex; 
    flex-direction: column; 
    background: #000;
  }

  /* Container for the video element */
  #video-container {
    flex: 1; 
    position: relative;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* Force Video.js to fill space */
  .video-js {
    width: 100% !important;
    height: 100% !important; 
  }

  /* Controls Bar */
  .controls-bar {
    margin-top: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    background: #222;
    padding: 10px;
    border-radius: 8px;
  }

  button { 
    padding: 10px 15px; 
    border: none; 
    border-radius: 6px; 
    background: #cc0000; 
    color: #fff; 
    cursor: pointer; 
    font-weight: bold; 
    white-space: nowrap;
  }
  button:hover { background: #ff0000; }
  
  /* Mode Switch Button Color */
  #modeBtn { background: #0066cc; }
  #modeBtn:hover { background: #0088ff; }

  /* Sidebar */
  .sidebar { 
    flex: 1; 
    background: #1f1f1f; 
    overflow-y: auto; 
    padding: 10px; 
    border-left: 1px solid #333; 
    min-width: 300px; /* Wider sidebar for better previews */
  }
  
  .search-bar { 
    width: 95%; 
    padding: 10px; 
    border-radius: 4px; 
    background: #121212; 
    color: #fff; 
    border: 1px solid #333; 
    margin-bottom: 15px; 
  }
  
  /* Sidebar Video Item */
  .video-item { 
    display: flex; 
    flex-direction: column; 
    margin-bottom: 20px; 
    cursor: pointer; 
    padding: 10px; 
    border-radius: 8px; 
    background: #121212; 
    transition: 0.2s; 
    border: 1px solid #333;
  }
  
  .video-item:hover { background: #2a2a2a; border-color: #555; }
  .video-item.active { border: 2px solid #cc0000; background: #222; }
  
  /* Preview Video Styling */
  .video-item video { 
    width: 100%; 
    height: 160px; /* Fixed height for consistency */
    object-fit: cover; /* Crops to fill the box neatly */
    border-radius: 6px; 
    background: #000; 
    pointer-events: none; /* Prevents clicking the video controls */
  }

  .video-item span { 
    display: block; 
    margin-top: 8px; 
    font-size: 14px; 
    color: #eee; 
    font-weight: bold;
    word-break: break-word;
  }
</style>
</head>
<body>

<div class="container">
  
  <div class="player-section">
    
    <div id="video-container"></div>
    
    <div class="controls-bar">
      <button id="nextBtn">Next ‚ñ∂</button>
      <button id="modeBtn">üîÑ Switch Mode (Currently: VR)</button>
      <button id="loadBtn">üìÅ Load Folder</button>
      <input type="file" id="folderPicker" webkitdirectory directory multiple accept="video/mp4" style="display:none;">
    </div>
  </div>

  <div class="sidebar">
    <input type="text" id="search" class="search-bar" placeholder="Search videos...">
    <div id="playlist"></div>
  </div>

</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script src="https://unpkg.com/videojs-vr/dist/videojs-vr.min.js"></script>

<script>
// --- Variables ---
let player = null;
let isVR = true; // Default start mode
let files = [];
let currentIndex = 0;
let currentUrl = null;

const playlistContainer = document.getElementById("playlist");
const folderPicker = document.getElementById("folderPicker");
const modeBtn = document.getElementById("modeBtn");
const videoContainer = document.getElementById("video-container");

// --- 1. Player Initialization Logic ---
function initPlayer(url, time = 0) {
  // If player exists, destroy it first
  if (player) {
    player.dispose();
    player = null;
  }

  // Inject fresh HTML for the video tag
  videoContainer.innerHTML = `
    <video id="player" class="video-js vjs-default-skin vjs-big-play-centered" controls crossorigin="anonymous" playsinline></video>
  `;

  // Initialize Video.js
  player = videojs('player');

  // Apply VR only if the flag is true
  if (isVR) {
    player.vr({ projection: '360', motionControls: true });
    modeBtn.textContent = "üîÑ Switch to Normal Mode";
  } else {
    modeBtn.textContent = "üîÑ Switch to 360 VR Mode";
  }

  // Load content
  if (url) {
    player.src({ src: url, type: 'video/mp4' });
    player.currentTime(time);
    player.play().catch(()=>{});
  }

  // Add event for auto-next
  player.on('ended', () => {
    currentIndex = (currentIndex + 1) % files.length;
    playVideo(currentIndex);
  });
}

// Initial setup (Empty player)
initPlayer(null);

// --- 2. Switch Mode Button Logic ---
modeBtn.addEventListener("click", () => {
  isVR = !isVR; 
  
  // Capture current time to resume playback seamlessly
  let currentTime = 0;
  if(player) currentTime = player.currentTime();

  // Re-initialize player with new mode
  initPlayer(currentUrl, currentTime);
});

// --- 3. Folder Loading & Playlist ---
document.getElementById("loadBtn").addEventListener("click", () => folderPicker.click());

folderPicker.addEventListener("change", (e) => {
  files = Array.from(e.target.files).filter(f => f.type.startsWith('video/'));
  if (files.length === 0) return alert("No video files found!");
  
  loadSidebar();
  playVideo(0);
});

function loadSidebar() {
  playlistContainer.innerHTML = "";
  
  files.forEach((file, i) => {
    const item = document.createElement("div");
    item.className = "video-item";
    
    // 1. Create Preview Video Element
    const previewVid = document.createElement("video");
    previewVid.src = URL.createObjectURL(file);
    previewVid.muted = true; // Mute previews
    previewVid.loop = true;  // Loop previews
    
    // Hover Effects: Play on hover, Pause on leave
    item.addEventListener("mouseenter", () => {
        previewVid.play().catch(()=>{}); 
    });
    item.addEventListener("mouseleave", () => {
        previewVid.pause();
        previewVid.currentTime = 0; // Reset preview to start
    });

    // 2. Create Label
    const label = document.createElement("span");
    label.textContent = (i+1) + ". " + file.name;
    
    // 3. Assemble Item
    item.appendChild(previewVid);
    item.appendChild(label);
    playlistContainer.appendChild(item);

    // 4. Click to Play Main Video
    item.addEventListener("click", () => playVideo(i));
  });
  
  highlightActive(0);
}

function playVideo(i) {
  if (!files[i]) return;
  currentIndex = i;
  highlightActive(i);

  const file = files[i];
  currentUrl = URL.createObjectURL(file); // Update global URL

  // If player exists, just change src (don't rebuild player unless switching modes)
  if (player) {
    player.src({ src: currentUrl, type: file.type });
    player.play().catch(()=>{});
  } else {
    initPlayer(currentUrl);
  }
}

function highlightActive(i) {
  document.querySelectorAll(".video-item").forEach((el, idx) => {
    el.classList.toggle("active", idx === i);
  });
}

// --- 4. Search & Next Button ---
document.getElementById("nextBtn").addEventListener("click", () => {
  if(files.length > 0) {
    currentIndex = (currentIndex + 1) % files.length;
    playVideo(currentIndex);
  }
});

document.getElementById("search").addEventListener("input", (e) => {
  const term = e.target.value.toLowerCase();
  document.querySelectorAll(".video-item").forEach(item => {
    item.style.display = item.innerText.toLowerCase().includes(term) ? "flex" : "none";
  });
});

</script>
</body>
</html>
